<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>checkpointing: brms • chkptstanr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="checkpointing: brms">
<meta property="og:description" content="chkptstanr">
<meta property="og:image" content="https://venpopov.github.io/chkptstanr/reference/figures/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">chkptstanr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/venpopov/chkptstanr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>checkpointing: brms</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/venpopov/chkptstanr/blob/HEAD/vignettes/chkpt_brms.Rmd" class="external-link"><code>vignettes/chkpt_brms.Rmd</code></a></small>
      <div class="hidden name"><code>chkpt_brms.Rmd</code></div>

    </div>

    
    
<p>The following examples walk through using <strong>chkptstanr</strong>
with the popular <code>R</code> package <a href="https://paul-buerkner.github.io/brms/" class="external-link"><strong>brms</strong></a>.</p>
<p>The basic idea is to (1) generate the <a href="https://mc-stan.org/users/interfaces/rstan" class="external-link"><strong>Stan</strong></a>
code with <strong>brms</strong>, (2) fit the model with <a href="https://mc-stan.org/cmdstanr/" class="external-link"><strong>cmdstanr</strong></a> (with
the desired number of checkpoints), and then (3) return a
<code>brmsfit</code> object. This is all done internally, so the
workflow is very similar to using <strong>brms</strong>.</p>
<div class="section level3">
<h3 id="packages">Packages<a class="anchor" aria-label="anchor" href="#packages"></a>
</h3>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/venpopov/chkptstanr" class="external-link">chkptstanr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/posterior/" class="external-link">posterior</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/bayesplot/" class="external-link">bayesplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/paul-buerkner/brms" class="external-link">brms</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-1-no-stopping">Example 1: No Stopping<a class="anchor" aria-label="anchor" href="#example-1-no-stopping"></a>
</h2>
<div class="section level3">
<h3 id="storage">Storage<a class="anchor" aria-label="anchor" href="#storage"></a>
</h3>
<p>The initial overhead is to create a folder that will store the
checkpoints, i.e.,</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_folder.html">create_folder</a></span><span class="op">(</span>folder_name  <span class="op">=</span> <span class="st">"chkpt_folder_m1"</span><span class="op">)</span></span></code></pre></div>
<p>which contains several additional folders (details can be found in
the documentation).</p>
</div>
<div class="section level3">
<h3 id="brmsformula">
<code>brmsformula</code><a class="anchor" aria-label="anchor" href="#brmsformula"></a>
</h3>
<p>In this example, we create a <code>brmsformula</code> object using
<code><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf()</a></code>. Note that for this model, we could also use formula
argument (e.g., <code>formula = y ~ x</code>), but in our experiences
<code><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf()</a></code> is more general.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bf_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>  <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting"></a>
</h3>
<p>The next step is to use <code><a href="../reference/chkpt_brms.html">chkpt_brms()</a></code>:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="va">bf_m1</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span><span class="op">)</span></span></code></pre></div>
<p>When running the above, a custom progress bar is printed that
includes information about the checkpoints.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#&gt; Compiling Stan program...</span></span>
<span><span class="co">#&gt; Initial Warmup (Typical Set)</span></span>
<span><span class="co">#&gt; Chkpt: 1 / 8; Iteration: 250 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 2 / 8; Iteration: 500 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 3 / 8; Iteration: 750 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 4 / 8; Iteration: 1000 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 5 / 8; Iteration: 1250 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 6 / 8; Iteration: 1500 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 7 / 8; Iteration: 1750 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 8 / 8; Iteration: 2000 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Checkpointing complete</span></span></code></pre></div>
<p>In this case, checkpointing is complete.</p>
</div>
<div class="section level3">
<h3 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p><code>fit_m1</code> is a <code>brmsfit</code> object which means that
all of the functionality of <strong>brms</strong> can still be used.</p>
<p>Here is the summary output:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m1</span></span>
<span></span>
<span><span class="co">#&gt;  Family: poisson </span></span>
<span><span class="co">#&gt;   Links: mu = log </span></span>
<span><span class="co">#&gt; Formula: count ~ zAge + zBase + (1 | patient) </span></span>
<span><span class="co">#&gt;    Data: data (Number of observations: 236) </span></span>
<span><span class="co">#&gt;   Draws: 2 chains, each with iter = 1000; warmup = 0; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Group-Level Effects: </span></span>
<span><span class="co">#&gt; ~patient (Number of levels: 59) </span></span>
<span><span class="co">#&gt;               Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; sd(Intercept)     0.58      0.07     0.46     0.73 1.00      349      682</span></span>
<span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     1.63      0.08     1.46     1.78 1.01      406      898</span></span>
<span><span class="co">#&gt; zAge          0.11      0.09    -0.06     0.27 1.00      463      796</span></span>
<span><span class="co">#&gt; zBase         0.73      0.08     0.58     0.89 1.00      613      814</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="posterior-predictive-check">Posterior Predictive Check<a class="anchor" aria-label="anchor" href="#posterior-predictive-check"></a>
</h3>
<p>Of course, due to being a <code>brmsfit</code> object, it is seamless
perform a posterior predictive check.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/pp_check.html" class="external-link">pp_check</a></span><span class="op">(</span><span class="va">fit_m1</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/pp_check_f1.png"></p>
</div>
</div>
<div class="section level2">
<h2 id="example-2-start-stop-start-etc-">Example 2: Start, Stop, Start, etc.<a class="anchor" aria-label="anchor" href="#example-2-start-stop-start-etc-"></a>
</h2>
<p>The previous example could just as well be fitted directly with
<strong>brms</strong>. This is because the MCMC sampler was not stopped
during model fitting.</p>
<p>In the following example, we illustrate the usefulness of
<strong>chkptstanr</strong>, i.e., the ability to stop the MCMC sampler
at will, and then pick right back up where the MCMC sampler left
off.</p>
<div class="section level3">
<h3 id="storage-1">Storage<a class="anchor" aria-label="anchor" href="#storage-1"></a>
</h3>
<p>The initial overhead is to create a folder that will store the
checkpoints, i.e.,</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_folder.html">create_folder</a></span><span class="op">(</span>folder_name  <span class="op">=</span> <span class="st">"chkpt_folder_m2"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="model-fitting-1">Model Fitting<a class="anchor" aria-label="anchor" href="#model-fitting-1"></a>
</h3>
<p>This model is mostly the same as above. The one difference is that it
does not include varying (“random”) intercepts.</p>
<div class="section level4">
<h4 id="start-and-stop-two-checkpoints">Start and Stop: Two Checkpoints<a class="anchor" aria-label="anchor" href="#start-and-stop-two-checkpoints"></a>
</h4>
<p>To illustrate checkpointing, the following was stopped after 2
checkpoints.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>,</span>
<span>            family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Compiling Stan program...</span></span>
<span><span class="co">#&gt; Initial Warmup (Typical Set)</span></span>
<span><span class="co">#&gt; Chkpt: 1 / 8; Iteration: 250 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 2 / 8; Iteration: 500 / 2000 (warmup)</span></span></code></pre></div>
<p>Note this was stopped by clicking on the red button aptly titled stop
(in the console).</p>
<p>This is but one use case, for example, needing to do something else
but not wanting to loose the progress (including the compiled model).
Another use case is scheduling, such that the model samples during
certain times until completion.</p>
</div>
<div class="section level4">
<h4 id="start-and-stop-two-more-checkpoints">Start and Stop: Two More Checkpoints<a class="anchor" aria-label="anchor" href="#start-and-stop-two-more-checkpoints"></a>
</h4>
<p>Now pick up at the next checkpoint. This is accomplished by simply
running the same code.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Sampling next checkpoint</span></span>
<span><span class="co">#&gt; Chkpt: 3 / 8; Iteration: 750 / 2000 (warmup)</span></span>
<span><span class="co">#&gt; Chkpt: 4 / 8; Iteration: 1000 / 2000 (warmup)</span></span></code></pre></div>
<p>Notice it picks up at right where it left off (stopped after 2
checkpoints)</p>
</div>
<div class="section level4">
<h4 id="start-finish-checkpointing">Start: Finish Checkpointing<a class="anchor" aria-label="anchor" href="#start-finish-checkpointing"></a>
</h4>
<p>Now let us finish the remaining 4 checkpoints.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Sampling next checkpoint</span></span>
<span><span class="co">#&gt; Chkpt: 5 / 8; Iteration: 1250 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 6 / 8; Iteration: 1500 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 7 / 8; Iteration: 1750 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Chkpt: 8 / 8; Iteration: 2000 / 2000 (sample)</span></span>
<span><span class="co">#&gt; Checkpointing complete</span></span></code></pre></div>
<p>If we trying running the model again, we get the following
message:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Sampling next checkpoint</span></span>
<span><span class="co">#&gt; Checkpointing complete</span></span></code></pre></div>
<p>Note that the arguments need to be exactly the same when
restarting.</p>
<p>There is a check for <code>data</code>, <code>formula</code>,
<code>iter_per_chkpt</code>, etc., and if they have been changed, this
will produce an error (with an informative warning message).</p>
</div>
</div>
<div class="section level3">
<h3 id="diagnostics">Diagnostics<a class="anchor" aria-label="anchor" href="#diagnostics"></a>
</h3>
<p>Some diagnostic information is provided in the summary output.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_m2</span></span>
<span></span>
<span><span class="co">#&gt; Family: poisson </span></span>
<span><span class="co">#&gt;   Links: mu = log </span></span>
<span><span class="co">#&gt; Formula: count ~ zAge + zBase </span></span>
<span><span class="co">#&gt;    Data: data (Number of observations: 236) </span></span>
<span><span class="co">#&gt;   Draws: 2 chains, each with iter = 1000; warmup = 0; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     1.84      0.03     1.78     1.89 1.00     1037     1009</span></span>
<span><span class="co">#&gt; zAge          0.16      0.02     0.11     0.21 1.00     1192      945</span></span>
<span><span class="co">#&gt; zBase         0.60      0.01     0.58     0.63 1.00     1463     1559</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sample(hmc). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>These diagnostics indicate the inference converged.</p>
</div>
<div class="section level3">
<h3 id="more-diagnostics">More Diagnostics<a class="anchor" aria-label="anchor" href="#more-diagnostics"></a>
</h3>
<p><strong>cmdstanr</strong> works with several packages in the
<strong>Stan</strong> ecosystem, including <a href="https://mc-stan.org/posterior/" class="external-link"><strong>posterior</strong></a> and
<a href="https://mc-stan.org/bayesplot/" class="external-link"><strong>bayesplot</strong></a>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># draws for bayesplot</span></span>
<span><span class="va">draws</span> <span class="op">&lt;-</span> <span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_array.html" class="external-link">as_draws_array</a></span><span class="op">(</span><span class="va">fit_m2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># trace plot</span></span>
<span><span class="fu">bayesplot</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/bayesplot/reference/MCMC-traces.html" class="external-link">mcmc_trace</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">draws</span>, pars <span class="op">=</span> <span class="st">"b_zAge"</span><span class="op">)</span> <span class="op">+</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1000</span>, <span class="fl">250</span><span class="op">)</span>, </span>
<span>           alpha <span class="op">=</span> <span class="fl">0.25</span>,</span>
<span>           size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/trace_f2.png"></p>
<p>This vertical lines are placed at each checkpoint.</p>
</div>
<div class="section level3">
<h3 id="model-comparison">Model Comparison<a class="anchor" aria-label="anchor" href="#model-comparison"></a>
</h3>
<p>These models can then be compared with approximate leave-one-out
cross-validation (via the <code>R</code> package <a href="http://mc-stan.org/loo/index.html" class="external-link"><strong>loo</strong></a>).</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo_compare.html" class="external-link">loo_compare</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">fit_m1</span><span class="op">)</span>, <span class="fu"><a href="https://mc-stan.org/loo/reference/loo.html" class="external-link">loo</a></span><span class="op">(</span><span class="va">fit_m2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt;       elpd_diff se_diff</span></span>
<span><span class="co">#&gt; fit_m1    0.0       0.0 </span></span>
<span><span class="co">#&gt; fit_m2 -203.6      65.4 </span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="compare-to-brm">Compare to <code>brm</code><a class="anchor" aria-label="anchor" href="#compare-to-brm"></a>
</h2>
<p>For a sanity check, here is <code>fit_m2</code> fitted with
<strong>brms</strong>. The estimates should be (basically) the same.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_brms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm</a></span><span class="op">(</span></span>
<span>  formula <span class="op">=</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>,</span>
<span>               family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">2000</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">fit_brms</span></span>
<span></span>
<span><span class="co">#&gt;  Family: poisson </span></span>
<span><span class="co">#&gt;   Links: mu = log </span></span>
<span><span class="co">#&gt; Formula: count ~ zAge + zBase </span></span>
<span><span class="co">#&gt;    Data: epilepsy (Number of observations: 236) </span></span>
<span><span class="co">#&gt;   Draws: 2 chains, each with iter = 2000; warmup = 1000; thin = 1;</span></span>
<span><span class="co">#&gt;          total post-warmup draws = 2000</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Population-Level Effects: </span></span>
<span><span class="co">#&gt;           Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS</span></span>
<span><span class="co">#&gt; Intercept     1.84      0.03     1.78     1.89 1.00     1247     1310</span></span>
<span><span class="co">#&gt; zAge          0.16      0.02     0.11     0.21 1.00     1226     1191</span></span>
<span><span class="co">#&gt; zBase         0.60      0.01     0.57     0.63 1.00     1107     1229</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS</span></span>
<span><span class="co">#&gt; and Tail_ESS are effective sample size measures, and Rhat is the potential</span></span>
<span><span class="co">#&gt; scale reduction factor on split chains (at convergence, Rhat = 1).</span></span></code></pre></div>
<p>The results for the parameter estimates and diagnostics are very
similar (as expected).</p>
</div>
<div class="section level2">
<h2 id="example-3-user-defined-priors">Example 3: User Defined Priors<a class="anchor" aria-label="anchor" href="#example-3-user-defined-priors"></a>
</h2>
<p><code><a href="../reference/chkpt_brms.html">chkpt_brms()</a></code> includes <code>...</code> which passes any
number of (valid) arguments to <code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm()</a></code>. Accordingly, priors
can be specified as though <code><a href="https://paul-buerkner.github.io/brms/reference/brm.html" class="external-link">brm()</a></code> was used.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_folder.html">create_folder</a></span><span class="op">(</span>folder_name <span class="op">=</span> <span class="st">"chkpt_folder_m3"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># priors</span></span>
<span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">constant</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">constant</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span>, coef <span class="op">=</span> <span class="st">"zBase"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/set_prior.html" class="external-link">prior</a></span><span class="op">(</span><span class="fu">constant</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"sd"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit model</span></span>
<span><span class="va">fit_m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/chkpt_brms.html">chkpt_brms</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://paul-buerkner.github.io/brms/reference/brmsformula.html" class="external-link">bf</a></span><span class="op">(</span>formula <span class="op">=</span> <span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span>  <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">|</span> <span class="va">patient</span><span class="op">)</span>,</span>
<span>     family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="va">bprior</span>,</span>
<span>  data <span class="op">=</span> <span class="va">epilepsy</span>,</span>
<span>  path  <span class="op">=</span> <span class="va">path</span>,</span>
<span>  iter_warmup <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_sampling <span class="op">=</span> <span class="fl">1000</span>,</span>
<span>  iter_per_chkpt <span class="op">=</span> <span class="fl">250</span>,</span>
<span>  brmsfit <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">prior_summary()</a></code> can be used to confirm that the priors
found their way into the model correctly, i.e.,</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://mc-stan.org/rstantools/reference/prior_summary.html" class="external-link">prior_summary</a></span><span class="op">(</span><span class="va">fit_m3</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt;                   prior     class      coef   group resp dpar nlpar bound       source</span></span>
<span><span class="co">#&gt;             constant(1)         b                                                 user</span></span>
<span><span class="co">#&gt;             constant(1)         b      zAge                               (vectorized)</span></span>
<span><span class="co">#&gt;             constant(2)         b     zBase                                       user</span></span>
<span><span class="co">#&gt;  student_t(3, 1.4, 2.5) Intercept                                              default</span></span>
<span><span class="co">#&gt;           constant(0.5)        sd                                                 user</span></span>
<span><span class="co">#&gt;           constant(0.5)        sd           patient                       (vectorized)</span></span>
<span><span class="co">#&gt;           constant(0.5)        sd Intercept patient                       (vectorized)</span></span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Vencislav Popov, Donald Williams, Tyler Matta.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
